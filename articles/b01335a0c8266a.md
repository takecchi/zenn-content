---
title: "NestJS+Prisma+Jestã§å®Ÿéš›ã®DBMSã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•ãƒ†ã‚¹ãƒˆ"
emoji: "ğŸ™Œ"
type: "tech"
topics:
  - "nestjs"
  - "prisma"
  - "jest"
  - "typescript"
published: true
---

## çµŒç·¯
å®Ÿéš›ã®DBMSã‚’ç”¨ã„ãŸãƒ†ã‚¹ãƒˆã‚’æ›¸ãéš›ã«ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹çš„ãªã‚‚ã®ãŒè¦‹ã¤ã‹ã‚‰ãšè©¦è¡ŒéŒ¯èª¤ã€‚  
ãã‚“ãªä¸­ã§è‡ªåˆ†ãªã‚Šã®çµè«–ãŒå‡ºãŸãŸã‚ã€åŒã˜æ‚©ã¿ã‚’æŒã£ãŸèª°ã‹ã®å¼•ãå‡ºã—ã«ãªã‚Œã°ã¨æ€ã„è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚

## å‰æ
* NestJS
* Typescript
* Prisma (`schema.prisma`ãŒã‚ã‚Š`npx prisma db push`ãŒé€šã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã“ã¨)
* postgres (å¤šåˆ†MySQLã§ã‚‚å•é¡Œãªã„ãŒã€ã“ã“ã§ã¯postgres)

## ã“ã®è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«
* ãƒ†ã‚¹ãƒˆæ¯ã«ãƒ‡ãƒ¼ã‚¿ãŒç©ºã«ãªã‚‹(å‡ºæ¥ã‚‹)ã“ã¨
* GitHub Actionsã§å®Ÿè¡Œã§ãã‚‹ã“ã¨
* Jestã‚’ä¸¦åˆ—ã§å®Ÿè¡Œã§ãã‚‹ã“ã¨
* `npm run test`ã§å®Ÿè¡Œã§ãã‚‹ã“ã¨

## ä¸‹æº–å‚™

### Docker
`docker-compose.yml`
```yaml
version: '3.9'
services:
  db:
    image: postgres:15.3
    restart: always
    container_name: integration-tests
    ports:
      - "5400:5432" # ç«¶åˆã‚’é¿ã‘ã¦5400ã¨ã—ã¦ã„ã¾ã™
    environment:
      POSTGRES_DB: "tests"
      POSTGRES_USER: "prisma"
      POSTGRES_PASSWORD: "prisma"
```

### package.json
`package.json`ã®`test`ã¯DockerãŒç«‹ã¡ä¸ŠãŒã‚‹ã‚ˆã†ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚
```json
{
  ...
  "scripts": {
    ...
    "test": "docker-compose up -d && jest && docker-compose down",
  },
}
```

### ç’°å¢ƒå¤‰æ•°
è‡ªåˆ†ã®å ´åˆã¯`.env.test`ã¨ã„ã†testç”¨ã®envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸãŒã€
å„ã€…ã®ç’°å¢ƒã«åˆã‚ã›è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
```env
# Local DB
DATABASE_URL="postgresql://prisma:prisma@localhost:5400/tests"
```

### ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®å®Ÿè£…
```ts
import { PrismaClient } from '@prisma/client';
import { PrismaClientKnownRequestError } from '@prisma/client/runtime/library';
import { execSync } from 'child_process';

/**
 * JEST_WORKDER_IDæ¯ã«Databaseã‚’ä½œæˆã—ã€ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†ã‚’è¡Œã†ã€‚
 */
export async function setupDatabase() {
  // ä½œæˆã™ã‚‹DBå
  const newDbName = `worker_${process.env.JEST_WORKER_ID}`;

  // DBã®ä½œæˆ
  const prisma = new PrismaClient();
  await prisma.$connect();
  try {
    await prisma.$executeRaw`CREATE DATABASE ${newDbName}`;
  } catch (error) {
    if (error instanceof PrismaClientKnownRequestError) {
      // DBä½œæˆæ¸ˆã¿ã ã£ãŸå ´åˆã¯ç„¡è¦–
      // æœ¬æ¥ã¯ã“ã“ã§ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸæ–¹ãŒè‰¯ã„ã€‚ä»Šå›ã¯å‰²æ„›
    } else {
      throw error;
    }
  }
  await prisma.$disconnect();

  // ç’°å¢ƒå¤‰æ•°ä¸Šæ›¸ã
  const dbUrl = new URL(process.env.DATABASE_URL ?? '');
  const baseUrl = dbUrl.href.substring(0, dbUrl.href.lastIndexOf('/'));
  process.env.DATABASE_URL = `${baseUrl}/${newDbName}`;

  // DBåˆæœŸåŒ–å‡¦ç†
  execSync('npx prisma migrate reset --force --skip-seed', {
    env: {
      ...process.env,
    },
  });
  execSync('npx prisma db push', {
    env: {
      ...process.env,
    },
  });
}
```
ã“ã‚Œã§`setupDatabase`é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ä»»æ„ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§DBã‚’ãƒªã‚»ãƒƒãƒˆå‡ºæ¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

`execSync`ã‚’ä½¿ç”¨ã—ãŸåˆæœŸåŒ–ã‚„`JEST_WORKER_ID`æ¯ã«DBã‚’ä½œã‚‹ã¨ã„ã†ã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™ã€‚  
https://www.mizdra.net/entry/2022/11/24/153459

## ä½¿ç”¨ä¾‹

### beforeAllã§ä¸€å›ã ã‘åˆæœŸåŒ–
```ts
describe('UserService Integration Test', () => {
    let service: UserService;
    let prisma: PrismaService;

    beforeAll(async () => {
        // æœ€åˆã®ä¸€å›ã ã‘åˆæœŸåŒ–
        await setupDatabase();

        const module: TestingModule = await Test.createTestingModule({
            providers: [
                UserService,
                PrismaService,
                LoggingService,
            ],
        }).compile();

        service = module.get<UserService>(UserService);
        prisma = module.get<PrismaService>(PrismaService);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥
        await prisma.userEntity.create({
            data: {
                id: 1,
                name: 'TEST_USER'
            },
        });
    });
}, 1000); // setupDatabaseã®æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆã¯ã“ã®ã‚ˆã†ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚é–“ã‚’ä¼¸ã°ã—ã¦ãã ã•ã„

it('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã§ãã‚‹ã“ã¨', async () => {
    const user = await service.getUser(1);// DBã‹ã‚‰ID:1ã‚’å–å¾—ã™ã‚‹å‡¦ç†
    expect(user.id).toBe(1);
    expect(user.name).toBe('TEST_USER');
});
```

### jest.setup.tsã§è‡ªå‹•çš„ã«åˆæœŸåŒ–
`jest.setup.ts`ã§å®£è¨€ã™ã‚Œã°ãƒ†ã‚¹ãƒˆæ¯ã«å‘¼ã³å‡ºã™å¿…è¦ãŒãªããªã‚Šã¾ã™ã€‚  

`jest.config.ts`
```ts
module.exports = {
    ...,
    setupFilesAfterEnv: ['jest.setup.ts']
}
```

`jest.setup.ts`
```ts
beforeAll(async () => {
    await setupDatabase();
}
```

ãŸã ã€è‡ªåˆ†ã®ç’°å¢ƒã§ã¯DBã«é–¢é€£ã—ãªã„é–¢æ•°ã®ãƒ†ã‚¹ãƒˆã‚‚å«ã¾ã‚Œã¦ã„ãŸç‚ºã€`jest.setup.ts`ã§ã¯ãªããƒ†ã‚¹ãƒˆæ¯ã«å‘¼ã³å‡ºã™æ–¹å¼ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

### GitHub Actions (workflow)
```yaml
name: Integration Test
on: pull_request
jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: NPM install
        run: npm install

      - name: TSC
        run: tsc

      - name: Run Test
        run: npm run test
```

## æœ€å¾Œã«
`setupDatabase`ã¯ã©ã†ã—ã¦ã‚‚æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã†ã®ãŒæ°—ã«ãªã‚Šãƒã‚¤ãƒ³ãƒˆã§ã™ã­ã€‚

DBã®åˆæœŸåŒ–ã¯ä»–ã«ã„ã„æ„Ÿã˜ã®æ–¹æ³•ã‚ã‚‹ã¨æ€ã£ã¦ã¯ã„ã¾ã™ãŒã€ä¸€æ—¦è«¦ã‚ãŸæ„Ÿã˜ã§ã™ã€‚
ã‚‚ã£ã¨ã„ã„æ–¹æ³•ã‚ã‚‹ã‚ˆï¼ã£ã¦æ–¹ãŒã„ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã§æ•™ãˆã¦é ‚ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚
ã€
